<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™æ¬¡å…ƒç­¾åˆ°é¢†ç§¯åˆ†</title>
    <style>
        * {margin: 0; padding: 0; box-sizing: border-box; font-family: "å¾®è½¯é›…é»‘", "å¹¼åœ†", sans-serif;}
        body {background: linear-gradient(135deg, #f8dfff, #e6f7ff); min-height: 100vh; padding: 20px;}
        .container {max-width: 500px; margin: 50px auto; background: rgba(255,255,255,0.95); border-radius: 20px; padding: 30px; box-shadow: 0 8px 32px rgba(180, 120, 255, 0.2); border: 2px solid #f0c8ff;}
        .title {text-align: center; color: #9333ea; font-size: 28px; margin-bottom: 30px; text-shadow: 2px 2px 4px rgba(147,51,234,0.2);}
        .title img {width: 50px; vertical-align: middle; margin-right: 10px;}
        .input-box {margin: 20px 0;}
        input {width: 100%; padding: 15px; border: 2px solid #d8b4fe; border-radius: 12px; font-size: 16px; outline: none; transition: all 0.3s;}
        input:focus {border-color: #9333ea; box-shadow: 0 0 8px rgba(147,51,234,0.3);}
        .btn-group {display: flex; gap: 15px; margin-top: 30px;}
        button {flex: 1; padding: 15px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s;}
        .sign-btn {background: linear-gradient(90deg, #9333ea, #c084fc); color: white;}
        .query-btn {background: linear-gradient(90deg, #3b82f6, #60a5fa); color: white;}
        button:hover {transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.2);}
        button:active {transform: translateY(0);}
        .tip {text-align: center; margin-top: 20px; color: #6b7280; font-size: 14px;}
        .modal {position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 999;}
        .modal-content {background: white; border-radius: 15px; padding: 30px; text-align: center; width: 80%; max-width: 400px; border: 3px solid #f0c8ff;}
        .modal-content h3 {color: #9333ea; margin-bottom: 20px; font-size: 22px;}
        .modal-content p {font-size: 18px; margin: 10px 0; color: #374151;}
        .close-btn {margin-top: 20px; padding: 10px 30px; background: #f0c8ff; color: #9333ea; border-radius: 8px; border: none; cursor: pointer; font-size: 16px;}
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">
            <img src="https://cdn-icons-png.flaticon.com/512/6134/6134546.png" alt="äºŒæ¬¡å…ƒå›¾æ ‡">
            é™æ¬¡å…ƒç­¾åˆ°é¢†ç§¯åˆ†
        </h1>
        <div class="input-box">
            <input type="text" id="qqInput" placeholder="è¯·è¾“å…¥ä½ çš„QQå·" maxlength="15">
        </div>
        <div class="btn-group">
            <button class="sign-btn" onclick="signIn()">ç«‹å³ç­¾åˆ°</button>
            <button class="query-btn" onclick="queryScore()">æŸ¥è¯¢ç§¯åˆ†</button>
        </div>
        <p class="tip">æ¯æ—¥ä»…å¯ç­¾åˆ°1æ¬¡ï¼Œç§¯åˆ†æ°¸ä¹…æœ‰æ•ˆï½</p>
    </div>

    <!-- å¼¹çª— -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h3 id="modalTitle">ç­¾åˆ°æˆåŠŸ</h3>
            <p id="modalText">æ­å–œä½ ï¼Œè·å¾—XXç§¯åˆ†ï¼Œå½“å‰æ€»ç§¯åˆ†ï¼šXX</p>
            <button class="close-btn" onclick="closeModal()">ç¡®å®š</button>
        </div>
    </div>

    <script>
        // å¼¹çª—æ§åˆ¶
        function openModal() {document.getElementById('modal').style.display = 'flex';}
        function closeModal() {document.getElementById('modal').style.display = 'none';}
        // éªŒè¯QQå·
        function checkQQ(qq) {return /^[1-9]\d{4,14}$/.test(qq);}
        // è·å–å½“å‰æ—¥æœŸï¼ˆyyyy-mm-ddï¼‰
        function getToday() {return new Date().toISOString().split('T')[0];}

        // ç­¾åˆ°åŠŸèƒ½
        async function signIn() {
            const qq = document.getElementById('qqInput').value.trim();
            if (!checkQQ(qq)) {
                document.getElementById('modalTitle').innerText = 'è¾“å…¥é”™è¯¯';
                document.getElementById('modalText').innerText = 'è¯·è¾“å…¥æœ‰æ•ˆçš„QQå·ï¼ˆ5-15ä½æ•°å­—ï¼Œé¦–ä½é0ï¼‰';
                openModal();
                return;
            }
            try {
                // è·å–æ•°æ®æ–‡ä»¶
                let res = await fetch('data.json');
                let data = await res.json();
                const today = getToday();
                const user = data.users.find(u => u.qq === qq) || null;

                // å·²ç­¾åˆ°åˆ¤æ–­
                if (user && user.lastSign === today) {
                    document.getElementById('modalTitle').innerText = 'ç­¾åˆ°æç¤º';
                    document.getElementById('modalText').innerText = `ä½ ä»Šå¤©å·²ç»ç­¾åˆ°è¿‡å•¦ï¼Œæ˜å¤©å†æ¥å§ï½å½“å‰ç§¯åˆ†ï¼š${user.score}`;
                    openModal();
                    return;
                }

                // æœªç­¾åˆ°ï¼šæ›´æ–°ç§¯åˆ†å’Œç­¾åˆ°æ—¶é—´
                const addScore = data.signScore; // åå°è®¾ç½®çš„ç­¾åˆ°ç§¯åˆ†
                if (user) {
                    user.score += addScore;
                    user.lastSign = today;
                } else {
                    data.users.push({qq, score: addScore, lastSign: today});
                }

                // æäº¤ä¿®æ”¹åˆ°GitHubï¼ˆéœ€å¼€å¯GitHub Pagesä¸”å…è®¸è·¨åŸŸï¼Œæˆ–ç”¨GitHub ActionsåŒæ­¥ï¼‰
                await fetch(window.location.href + 'data.json', {
                    method: 'PUT',
                    body: JSON.stringify(data, null, 2),
                    headers: {'Content-Type': 'application/json'}
                });

                // ç­¾åˆ°æˆåŠŸå¼¹çª—
                const totalScore = user ? user.score : addScore;
                document.getElementById('modalTitle').innerText = 'ç­¾åˆ°æˆåŠŸğŸ‰';
                document.getElementById('modalText').innerText = `æ­å–œä½ ï¼Œè·å¾—${addScore}ç§¯åˆ†ï¼Œå½“å‰æ€»ç§¯åˆ†ï¼š${totalScore}`;
                openModal();
            } catch (err) {
                document.getElementById('modalTitle').innerText = 'æ“ä½œå¤±è´¥';
                document.getElementById('modalText').innerText = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ï½';
                openModal();
                console.error(err);
            }
        }

        // ç§¯åˆ†æŸ¥è¯¢
        async function queryScore() {
            const qq = document.getElementById('qqInput').value.trim();
            if (!checkQQ(qq)) {
                document.getElementById('modalTitle').innerText = 'è¾“å…¥é”™è¯¯';
                document.getElementById('modalText').innerText = 'è¯·è¾“å…¥æœ‰æ•ˆçš„QQå·ï¼ˆ5-15ä½æ•°å­—ï¼Œé¦–ä½é0ï¼‰';
                openModal();
                return;
            }
            try {
                const res = await fetch('data.json');
                const data = await res.json();
                const user = data.users.find(u => u.qq === qq) || null;
                if (user) {
                    document.getElementById('modalTitle').innerText = 'ç§¯åˆ†æŸ¥è¯¢ç»“æœ';
                    document.getElementById('modalText').innerText = `QQå·${qq}ï¼šå½“å‰ç§¯åˆ†${user.score}ï¼Œæœ€åç­¾åˆ°æ—¶é—´ï¼š${user.lastSign || 'ä»æœªç­¾åˆ°'}`;
                } else {
                    document.getElementById('modalTitle').innerText = 'ç§¯åˆ†æŸ¥è¯¢ç»“æœ';
                    document.getElementById('modalText').innerText = `QQå·${qq}ï¼šæš‚æ— è®°å½•ï¼Œå¿«å»ç­¾åˆ°è·å–ç¬¬ä¸€ç¬”ç§¯åˆ†å§ï½`;
                }
                openModal();
            } catch (err) {
                document.getElementById('modalTitle').innerText = 'æŸ¥è¯¢å¤±è´¥';
                document.getElementById('modalText').innerText = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ï½';
                openModal();
                console.error(err);
            }
        }
    </script>
</body>
</html>
